server {
  listen _PORT_; # This will be replaced by the script
  server_name localhost;

  root /usr/share/nginx/html;
  index index.html index.htm;

  # This handles all React routing
  location / {
    try_files $uri $uri/ /index.html;
  }
  
  # This forwards all API calls to the backend container using a regex match.
  # It's a more robust method than using 'rewrite'.
  location ~ ^/api/(.*)$ {
    
    # Proxy the request to the backend, appending the captured path.
    resolver 8.8.8.8;
    # e.g., /api/auth/register becomes https://.../auth/register
    proxy_pass https://skillsync-backend-1078370935935.us-central1.run.app/$1;
    
    # --- Timeouts for long AI calls ---
    proxy_connect_timeout 300s;
    proxy_send_timeout    300s;
    proxy_read_timeout    300s;
    
    # --- Standard proxy headers ---
    # Set the Host header to the backend's hostname. This is crucial for Cloud Run.
    proxy_set_header Host skillsync-backend-1078370935935.us-central1.run.app;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}